```mysql
/* =========================================================
   项目数据库（PostgreSQL）- 可直接导入执行
   约束说明：
   1) 全库不使用外键约束（仅“逻辑外键”字段 + 中文注释说明）
   2) 每个字段均有中文注释
   3) 问答溯源采用“方案A”：存入 chat_message.raw(JSONB)
   ========================================================= */

-- 0) 扩展：UUID 生成
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- =========================================================
-- 1) 用户表 app_user
-- =========================================================
CREATE TABLE IF NOT EXISTS app_user (
  id            uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  username      text NOT NULL UNIQUE,
  password_hash text NOT NULL,
  display_name  text,
  role          text NOT NULL CHECK (role IN ('admin','user')),
  is_active     boolean NOT NULL DEFAULT true,
  created_at    timestamptz NOT NULL DEFAULT now(),
  updated_at    timestamptz NOT NULL DEFAULT now()
);

COMMENT ON TABLE app_user IS '用户表（管理员/普通用户）';
COMMENT ON COLUMN app_user.id IS '用户ID（主键）';
COMMENT ON COLUMN app_user.username IS '用户名（唯一）';
COMMENT ON COLUMN app_user.password_hash IS '密码哈希（不可明文存储）';
COMMENT ON COLUMN app_user.display_name IS '显示名称/昵称（可空）';
COMMENT ON COLUMN app_user.role IS '角色（admin=管理员，user=普通用户）';
COMMENT ON COLUMN app_user.is_active IS '是否启用（true启用/false禁用）';
COMMENT ON COLUMN app_user.created_at IS '创建时间';
COMMENT ON COLUMN app_user.updated_at IS '更新时间';

-- =========================================================
-- 2) 文件表 file_asset（文件不入库，只存路径/Key）
-- =========================================================
CREATE TABLE IF NOT EXISTS file_asset (
  id          uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  module      text NOT NULL,               -- 例如：kb/template/export/doc
  file_name   text NOT NULL,
  file_path   text NOT NULL,               -- 本地路径或对象存储Key
  mime_type   text,
  file_size   bigint,
  sha256      text,
  created_by  uuid,                        -- 逻辑外键：app_user.id
  created_at  timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_file_asset_module_created_at
  ON file_asset(module, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_file_asset_created_by
  ON file_asset(created_by, created_at DESC);

COMMENT ON TABLE file_asset IS '文件表（仅存元数据与路径，不存文件内容）';
COMMENT ON COLUMN file_asset.id IS '文件ID（主键）';
COMMENT ON COLUMN file_asset.module IS '所属模块（kb/template/export/doc等，自定义即可）';
COMMENT ON COLUMN file_asset.file_name IS '文件名';
COMMENT ON COLUMN file_asset.file_path IS '文件路径/对象存储Key（用于预览/下载/跳转原文）';
COMMENT ON COLUMN file_asset.mime_type IS 'MIME类型（可空）';
COMMENT ON COLUMN file_asset.file_size IS '文件大小（字节，可空）';
COMMENT ON COLUMN file_asset.sha256 IS '文件SHA256校验值（可空）';
COMMENT ON COLUMN file_asset.created_by IS '创建人用户ID（逻辑外键：app_user.id，可空）';
COMMENT ON COLUMN file_asset.created_at IS '创建时间';

-- =========================================================
-- 3) 审计日志 audit_log（建议保留>=6个月，清理由定时任务实现）
-- =========================================================
CREATE TABLE IF NOT EXISTS audit_log (
  id          bigserial PRIMARY KEY,
  user_id     uuid,                        -- 逻辑外键：app_user.id
  module      text NOT NULL,               -- doc/qa/kb/auth/template/file 等
  action      text NOT NULL,               -- create/update/delete/upload/export/ask/login...
  entity_type text,                        -- 业务对象类型：gov_document/kb_document/chat_message/file_asset 等
  entity_id   uuid,                        -- 业务对象ID（逻辑外键：按entity_type解释）
  detail      jsonb NOT NULL DEFAULT '{}'::jsonb,
  ip          inet,
  user_agent  text,
  created_at  timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_audit_log_created_at
  ON audit_log(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_audit_log_user_created_at
  ON audit_log(user_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_audit_log_module_created_at
  ON audit_log(module, created_at DESC);

COMMENT ON TABLE audit_log IS '审计日志（操作留痕：谁在何时对哪个对象做了什么）';
COMMENT ON COLUMN audit_log.id IS '日志ID（主键，自增）';
COMMENT ON COLUMN audit_log.user_id IS '操作人用户ID（逻辑外键：app_user.id，可空）';
COMMENT ON COLUMN audit_log.module IS '模块标识（doc/qa/kb/auth/template/file等）';
COMMENT ON COLUMN audit_log.action IS '动作（create/update/delete/upload/export/ask/login等）';
COMMENT ON COLUMN audit_log.entity_type IS '对象类型（如gov_document/kb_document/chat_message等，可空）';
COMMENT ON COLUMN audit_log.entity_id IS '对象ID（逻辑外键：按entity_type解释，可空）';
COMMENT ON COLUMN audit_log.detail IS '操作详情（JSON，建议存请求参数摘要/导出类型/错误信息等）';
COMMENT ON COLUMN audit_log.ip IS '客户端IP（可空）';
COMMENT ON COLUMN audit_log.user_agent IS 'User-Agent（可空）';
COMMENT ON COLUMN audit_log.created_at IS '创建时间';

-- =========================================================
-- 4) 系统配置 system_setting（规则/阈值/开关，JSON 便于快速迭代）
-- =========================================================
CREATE TABLE IF NOT EXISTS system_setting (
  key         text PRIMARY KEY,
  value       jsonb NOT NULL,
  updated_at  timestamptz NOT NULL DEFAULT now()
);

COMMENT ON TABLE system_setting IS '系统配置表（JSON配置：问答规则/阈值/开关等）';
COMMENT ON COLUMN system_setting.key IS '配置键（主键，如qa_rules、doc_defaults等）';
COMMENT ON COLUMN system_setting.value IS '配置值（JSON）';
COMMENT ON COLUMN system_setting.updated_at IS '更新时间';

-- =========================================================
-- 5) 敏感词 sensitive_word（用于公文审核/问答过滤）
-- =========================================================
CREATE TABLE IF NOT EXISTS sensitive_word (
  id          bigserial PRIMARY KEY,
  word        text NOT NULL UNIQUE,
  level       smallint NOT NULL DEFAULT 1, -- 1提示 2拦截 3禁止
  note        text,
  created_by  uuid,                        -- 逻辑外键：app_user.id
  created_at  timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_sensitive_word_level
  ON sensitive_word(level);

COMMENT ON TABLE sensitive_word IS '敏感词库（公文审核与问答过滤共用）';
COMMENT ON COLUMN sensitive_word.id IS '敏感词ID（主键，自增）';
COMMENT ON COLUMN sensitive_word.word IS '敏感词（唯一）';
COMMENT ON COLUMN sensitive_word.level IS '级别（1提示/2拦截/3禁止）';
COMMENT ON COLUMN sensitive_word.note IS '备注说明（可空）';
COMMENT ON COLUMN sensitive_word.created_by IS '创建人用户ID（逻辑外键：app_user.id，可空）';
COMMENT ON COLUMN sensitive_word.created_at IS '创建时间';

-- =========================================================
-- 6) 公文模板 doc_template
-- =========================================================
CREATE TABLE IF NOT EXISTS doc_template (
  id            uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name          text NOT NULL,
  doc_type      text NOT NULL,             -- 请示/报告/通知...
  description   text,
  template_file_id uuid,                   -- 逻辑外键：file_asset.id（模板文件，可空）
  format_config jsonb NOT NULL DEFAULT '{}'::jsonb,  -- 排版参数JSON
  is_public     boolean NOT NULL DEFAULT false,
  created_by    uuid,                      -- 逻辑外键：app_user.id（可空）
  created_at    timestamptz NOT NULL DEFAULT now(),
  updated_at    timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_doc_template_doc_type
  ON doc_template(doc_type);
CREATE INDEX IF NOT EXISTS idx_doc_template_created_by
  ON doc_template(created_by, created_at DESC);

COMMENT ON TABLE doc_template IS '公文模板表（格式规范/自定义模板）';
COMMENT ON COLUMN doc_template.id IS '模板ID（主键）';
COMMENT ON COLUMN doc_template.name IS '模板名称';
COMMENT ON COLUMN doc_template.doc_type IS '公文类型（请示/报告/通知等）';
COMMENT ON COLUMN doc_template.description IS '模板描述（可空）';
COMMENT ON COLUMN doc_template.template_file_id IS '模板文件ID（逻辑外键：file_asset.id，可空）';
COMMENT ON COLUMN doc_template.format_config IS '格式配置（JSON：字体/字号/行距/页码/落款等）';
COMMENT ON COLUMN doc_template.is_public IS '是否公开（true=所有用户可用）';
COMMENT ON COLUMN doc_template.created_by IS '创建人用户ID（逻辑外键：app_user.id，可空）';
COMMENT ON COLUMN doc_template.created_at IS '创建时间';
COMMENT ON COLUMN doc_template.updated_at IS '更新时间';

-- =========================================================
-- 7) 公文主表 gov_document
-- =========================================================
CREATE TABLE IF NOT EXISTS gov_document (
  id            uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  title         text,
  doc_type      text NOT NULL,
  status        text NOT NULL DEFAULT 'draft'
                CHECK (status IN ('draft','generated','reviewed','final','archived')),
  template_id   uuid,                      -- 逻辑外键：doc_template.id（可空）
  form_data     jsonb NOT NULL DEFAULT '{}'::jsonb,  -- 表单输入
  llm_output    jsonb NOT NULL DEFAULT '{}'::jsonb,  -- LLM结构化输出
  content_text  text,                      -- 当前可编辑正文（最终以此为准）
  created_by    uuid NOT NULL,             -- 逻辑外键：app_user.id（建议必填便于权限隔离）
  created_at    timestamptz NOT NULL DEFAULT now(),
  updated_at    timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_gov_document_created_by_created_at
  ON gov_document(created_by, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_gov_document_status
  ON gov_document(status);
CREATE INDEX IF NOT EXISTS idx_gov_document_doc_type
  ON gov_document(doc_type);
CREATE INDEX IF NOT EXISTS idx_gov_document_template_id
  ON gov_document(template_id);

COMMENT ON TABLE gov_document IS '公文主表（起草/生成/编辑/定稿）';
COMMENT ON COLUMN gov_document.id IS '公文ID（主键）';
COMMENT ON COLUMN gov_document.title IS '公文标题（可空）';
COMMENT ON COLUMN gov_document.doc_type IS '公文类型（请示/报告/通知等）';
COMMENT ON COLUMN gov_document.status IS '状态（draft草稿/generated已生成/reviewed已审核/final定稿/archived归档）';
COMMENT ON COLUMN gov_document.template_id IS '模板ID（逻辑外键：doc_template.id，可空）';
COMMENT ON COLUMN gov_document.form_data IS '结构化表单输入（JSON）';
COMMENT ON COLUMN gov_document.llm_output IS '模型输出结构化结果（JSON）';
COMMENT ON COLUMN gov_document.content_text IS '当前正文内容（用户可编辑的最终文本，可空）';
COMMENT ON COLUMN gov_document.created_by IS '创建人用户ID（逻辑外键：app_user.id）';
COMMENT ON COLUMN gov_document.created_at IS '创建时间';
COMMENT ON COLUMN gov_document.updated_at IS '更新时间';

-- =========================================================
-- 8) 公文版本表 gov_document_revision
-- =========================================================
CREATE TABLE IF NOT EXISTS gov_document_revision (
  id            uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  document_id   uuid NOT NULL,             -- 逻辑外键：gov_document.id
  version_no    int  NOT NULL,
  content_text  text,
  llm_output    jsonb NOT NULL DEFAULT '{}'::jsonb,
  change_note   text,
  created_by    uuid,                      -- 逻辑外键：app_user.id（可空）
  created_at    timestamptz NOT NULL DEFAULT now(),
  UNIQUE(document_id, version_no)
);

CREATE INDEX IF NOT EXISTS idx_gov_document_revision_document_id_created_at
  ON gov_document_revision(document_id, created_at DESC);

COMMENT ON TABLE gov_document_revision IS '公文版本表（保存历史修改记录）';
COMMENT ON COLUMN gov_document_revision.id IS '版本ID（主键）';
COMMENT ON COLUMN gov_document_revision.document_id IS '公文ID（逻辑外键：gov_document.id）';
COMMENT ON COLUMN gov_document_revision.version_no IS '版本号（同一公文递增）';
COMMENT ON COLUMN gov_document_revision.content_text IS '该版本正文内容（可空）';
COMMENT ON COLUMN gov_document_revision.llm_output IS '该版本模型输出（JSON）';
COMMENT ON COLUMN gov_document_revision.change_note IS '修改说明/备注（可空）';
COMMENT ON COLUMN gov_document_revision.created_by IS '创建人用户ID（逻辑外键：app_user.id，可空）';
COMMENT ON COLUMN gov_document_revision.created_at IS '创建时间';

-- =========================================================
-- 9) 公文审核结果表 doc_review_result（推荐只绑定版本ID，避免冗余）
-- =========================================================
CREATE TABLE IF NOT EXISTS doc_review_result (
  id            uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  revision_id   uuid NOT NULL,             -- 逻辑外键：gov_document_revision.id
  result        jsonb NOT NULL DEFAULT '{}'::jsonb,  -- typo/grammar/sensitive/suggestions...
  has_sensitive boolean NOT NULL DEFAULT false,
  created_by    uuid,                      -- 逻辑外键：app_user.id（可空）
  created_at    timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_doc_review_result_revision_id_created_at
  ON doc_review_result(revision_id, created_at DESC);

COMMENT ON TABLE doc_review_result IS '公文审核结果表（错别字/语法/敏感词/建议）';
COMMENT ON COLUMN doc_review_result.id IS '审核结果ID（主键）';
COMMENT ON COLUMN doc_review_result.revision_id IS '版本ID（逻辑外键：gov_document_revision.id）';
COMMENT ON COLUMN doc_review_result.result IS '审核详情（JSON：问题列表、定位、建议等）';
COMMENT ON COLUMN doc_review_result.has_sensitive IS '是否包含敏感内容（true=包含）';
COMMENT ON COLUMN doc_review_result.created_by IS '创建人用户ID（逻辑外键：app_user.id，可空）';
COMMENT ON COLUMN doc_review_result.created_at IS '创建时间';

-- =========================================================
-- 10) 知识库集合表 kb_dataset（映射 Dify dataset）
-- =========================================================
CREATE TABLE IF NOT EXISTS kb_dataset (
  id              uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name            text NOT NULL,
  description     text,
  parent_id       uuid,                    -- 逻辑外键：kb_dataset.id（可空，树形分类）
  dify_dataset_id text,                    -- 对接Dify用，可空
  is_active       boolean NOT NULL DEFAULT true,
  created_by      uuid,                    -- 逻辑外键：app_user.id（可空）
  created_at      timestamptz NOT NULL DEFAULT now(),
  updated_at      timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_kb_dataset_parent_id
  ON kb_dataset(parent_id);
CREATE INDEX IF NOT EXISTS idx_kb_dataset_created_by_created_at
  ON kb_dataset(created_by, created_at DESC);

COMMENT ON TABLE kb_dataset IS '知识库集合表（类似文件夹/数据集，支持树形）';
COMMENT ON COLUMN kb_dataset.id IS '集合ID（主键）';
COMMENT ON COLUMN kb_dataset.name IS '集合名称';
COMMENT ON COLUMN kb_dataset.description IS '集合描述（可空）';
COMMENT ON COLUMN kb_dataset.parent_id IS '父集合ID（逻辑外键：kb_dataset.id，可空）';
COMMENT ON COLUMN kb_dataset.dify_dataset_id IS 'Dify数据集ID（映射Dify用，可空）';
COMMENT ON COLUMN kb_dataset.is_active IS '是否启用（true启用/false停用）';
COMMENT ON COLUMN kb_dataset.created_by IS '创建人用户ID（逻辑外键：app_user.id，可空）';
COMMENT ON COLUMN kb_dataset.created_at IS '创建时间';
COMMENT ON COLUMN kb_dataset.updated_at IS '更新时间';

-- =========================================================
-- 11) 知识库文档表 kb_document（映射 Dify document）
-- =========================================================
CREATE TABLE IF NOT EXISTS kb_document (
  id               uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  dataset_id        uuid NOT NULL,         -- 逻辑外键：kb_dataset.id
  title            text NOT NULL,
  source_type      text NOT NULL CHECK (source_type IN ('manual','upload','url')),
  source_uri       text,                   -- URL或来源说明（可空）
  file_id          uuid,                   -- 逻辑外键：file_asset.id（upload时使用，可空）
  content_text     text,                   -- manual时使用（可空）
  language         text NOT NULL DEFAULT 'zh-CN',
  status           text NOT NULL DEFAULT 'active' CHECK (status IN ('active','disabled')),
  dify_document_id text,                   -- 对接Dify用，可空
  created_by       uuid,                   -- 逻辑外键：app_user.id（可空）
  created_at       timestamptz NOT NULL DEFAULT now(),
  updated_at       timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_kb_document_dataset_id_created_at
  ON kb_document(dataset_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_kb_document_status
  ON kb_document(status);
CREATE INDEX IF NOT EXISTS idx_kb_document_file_id
  ON kb_document(file_id);

COMMENT ON TABLE kb_document IS '知识库文档表（集合下的具体资料：手工/上传/URL）';
COMMENT ON COLUMN kb_document.id IS '文档ID（主键）';
COMMENT ON COLUMN kb_document.dataset_id IS '集合ID（逻辑外键：kb_dataset.id）';
COMMENT ON COLUMN kb_document.title IS '文档标题';
COMMENT ON COLUMN kb_document.source_type IS '来源类型（manual手工/upload上传/url链接）';
COMMENT ON COLUMN kb_document.source_uri IS '来源地址（URL或来源说明，可空）';
COMMENT ON COLUMN kb_document.file_id IS '文件ID（逻辑外键：file_asset.id，upload场景使用，可空）';
COMMENT ON COLUMN kb_document.content_text IS '文档文本内容（manual场景使用，可空）';
COMMENT ON COLUMN kb_document.language IS '语言（默认zh-CN）';
COMMENT ON COLUMN kb_document.status IS '状态（active启用/disabled停用）';
COMMENT ON COLUMN kb_document.dify_document_id IS 'Dify文档ID（映射Dify用，可空）';
COMMENT ON COLUMN kb_document.created_by IS '创建人用户ID（逻辑外键：app_user.id，可空）';
COMMENT ON COLUMN kb_document.created_at IS '创建时间';
COMMENT ON COLUMN kb_document.updated_at IS '更新时间';

-- =========================================================
-- 12) 会话表 chat_session
-- =========================================================
CREATE TABLE IF NOT EXISTS chat_session (
  id                   uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id               uuid NOT NULL,     -- 逻辑外键：app_user.id
  scene                 text NOT NULL DEFAULT 'default',
  title                 text,
  dify_conversation_id  text,
  created_at            timestamptz NOT NULL DEFAULT now(),
  updated_at            timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_chat_session_user_updated_at
  ON chat_session(user_id, updated_at DESC);

COMMENT ON TABLE chat_session IS '问答会话表（多轮对话的容器/聊天窗口）';
COMMENT ON COLUMN chat_session.id IS '会话ID（主键）';
COMMENT ON COLUMN chat_session.user_id IS '用户ID（逻辑外键：app_user.id）';
COMMENT ON COLUMN chat_session.scene IS '业务场景标识（如default/制度查询/流程咨询等）';
COMMENT ON COLUMN chat_session.title IS '会话标题（用于会话列表展示，可空）';
COMMENT ON COLUMN chat_session.dify_conversation_id IS 'Dify会话ID（对接Dify时可用，可空）';
COMMENT ON COLUMN chat_session.created_at IS '创建时间';
COMMENT ON COLUMN chat_session.updated_at IS '更新时间';

-- =========================================================
-- 13) 消息表 chat_message（方案A：溯源 citations 存 raw）
-- =========================================================
CREATE TABLE IF NOT EXISTS chat_message (
  id          uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id  uuid NOT NULL,               -- 逻辑外键：chat_session.id
  role        text NOT NULL CHECK (role IN ('user','assistant','system')),
  content     text NOT NULL,
  raw         jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at  timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_chat_message_session_created_at
  ON chat_message(session_id, created_at);

-- 可选：未来如需按 raw 内字段做检索/统计（被引用次数等），再启用此索引
-- CREATE INDEX IF NOT EXISTS idx_chat_message_raw_gin ON chat_message USING gin(raw);

COMMENT ON TABLE chat_message IS '问答消息表（用户提问/助手回答/系统消息）';
COMMENT ON COLUMN chat_message.id IS '消息ID（主键）';
COMMENT ON COLUMN chat_message.session_id IS '会话ID（逻辑外键：chat_session.id）';
COMMENT ON COLUMN chat_message.role IS '角色（user=用户/assistant=助手/system=系统）';
COMMENT ON COLUMN chat_message.content IS '消息文本内容';
COMMENT ON COLUMN chat_message.raw IS
'原始扩展数据（JSON，方案A：回答溯源/citations也存这里）。建议结构：
{
  "source_type": "kb|llm|mixed",   -- 来源类型：知识库/通用知识/混合（通常assistant消息写）
  "citations": [
    {
      "kb_document_id": "uuid",    -- 逻辑外键：kb_document.id（可空）
      "file_id": "uuid",           -- 逻辑外键：file_asset.id（可空，用于跳转原文）
      "title": "文档标题",
      "source_uri": "原文URL或说明（可空）",
      "page": 3,                   -- 页码（可空）
      "quote": "引用片段（建议截断，避免过长）"
    }
  ],
  "token_usage": {"prompt":123,"completion":456},  -- 可空
  "latency_ms": 1200,                              -- 可空
  "dify": {...}                                    -- Dify原始返回（可选）
}
说明：一般仅assistant消息会包含source_type/citations。';
COMMENT ON COLUMN chat_message.created_at IS '创建时间';

-- =========================================================
-- 结束
-- =========================================================

```

