{
  "openapi": "3.0.1",
  "info": {
    "title": "GovAI 智政系统 - 后端↔Dify 集成 API",
    "description": "## 概述\n本文档定义 GovAI 后端与 Dify AI 引擎之间的所有交互规范。\nDify 在本架构中的定位为 **纯 AI 引擎**，不承载业务逻辑。\n\n## 架构分层\n```\n┌──────────────────────────────────────────────────────┐\n│                     FastAPI 后端                      │\n│  ┌──────────────────┐    ┌──────────────────────┐    │\n│  │  后端A（业务层）  │───→│  后端B（AI 对接层）   │    │\n│  │ routes/ services/ │    │ services/dify/*       │    │\n│  └──────────────────┘    └──────────┬───────────┘    │\n│                                      │                │\n└──────────────────────────────────────┼────────────────┘\n                                       │ HTTP / SSE\n                                ┌──────▼──────┐\n                                │  Dify 平台   │\n                                │  (自部署)    │\n                                ├─────────────┤\n                                │ Dataset API  │  知识库管理\n                                │ Workflow API │  公文AI流程\n                                │ Chat API     │  RAG问答\n                                └──────┬──────┘\n                                       │\n                                ┌──────▼──────┐\n                                │  向量数据库   │\n                                │ (Dify 内置)  │\n                                └─────────────┘\n```\n\n## 文件上传场景区分\n\nGovAI 系统中存在 **两种完全不同的文件上传场景**，请务必区分：\n\n### 场景 1：公文导入（Document Import）\n**目的**：将公文文件导入到 GovAI 文档管理系统\n**API 端点**：`POST /documents/import`（FastAPI 后端A，**不在本 OpenAPI 文档中**）\n**数据流向**：\n```\n前端 → FastAPI 后端A → PostgreSQL documents 表\n                    → 文件存储（本地/OSS）\n                    → Markdown 转换\n```\n**存储位置**：\n- 文件元数据：PostgreSQL `documents` 表\n- 文件内容：本地文件系统或对象存储\n- 转换结果：Markdown 格式存储在 `documents.content_markdown`\n\n**特点**：\n- ❌ 不调用 Dify API\n- ❌ 不进行向量化\n- ✅ 用于公文管理、版本控制、审批流程\n- ✅ 支持公文起草时作为参考素材\n\n---\n\n### 场景 2：知识库文档上传（Knowledge Base Upload）\n**目的**：将文件上传到 Dify 知识库，用于 RAG 检索问答\n**API 端点**：`POST /datasets/{dataset_id}/document/create-by-file`（**本文档定义**）\n**数据流向**：\n```\n前端 → FastAPI 后端A → FastAPI 后端B → Dify API\n                                      → 向量数据库（Dify 内置）\n```\n**存储位置**：\n- 文件元数据：PostgreSQL `kb_files` 表 + Dify 内部数据库\n- 文件内容：Dify 内部存储\n- 向量索引：Dify 向量数据库\n\n**特点**：\n- ✅ 调用 Dify Dataset API\n- ✅ 自动分块、向量化、索引\n- ✅ 用于智能问答、RAG 检索\n- ✅ 支持语义搜索\n\n---\n\n### 两者对比\n\n| 维度 | 公文导入 | 知识库上传 |\n|------|---------|------------|\n| **API 端点** | `/documents/import` | `/datasets/{dataset_id}/document/create-by-file` |\n| **是否调用 Dify** | ❌ 否 | ✅ 是 |\n| **数据库表** | `documents` | `kb_files` + `kb_collections` |\n| **是否向量化** | ❌ 否 | ✅ 是 |\n| **主要用途** | 公文管理、审批流程 | RAG 问答、知识检索 |\n| **文件转换** | PDF/DOCX → Markdown | 自动分块 + Embedding |\n| **检索方式** | SQL 全文检索 | 向量语义检索 |\n| **在本文档中** | ❌ 不包含 | ✅ 包含 |\n\n> ⚠️ **重要提示**：本 OpenAPI 文档仅定义 **后端↔Dify 的集成接口**，不包含 FastAPI 后端A 的业务接口（如 `/documents/import`）。如需查看完整的 GovAI API 文档，请参考 FastAPI 自动生成的文档（`/docs` 或 `/redoc`）。\n\n## 认证机制\nDify API 使用 **API Key** 认证，在 HTTP Header 中携带：\n```\nAuthorization: Bearer {dify_api_key}\n```\n\n### API Key 分类\n| Key 类型 | 用途 | 获取位置 |\n|----------|------|----------|\n| `DIFY_DATASET_API_KEY` | 知识库/数据集管理 | Dify → 知识库 → API 管理 |\n| `DIFY_APP_DOC_DRAFT_KEY` | 公文起草 Workflow | Dify → 应用 → API 访问 |\n| `DIFY_APP_DOC_CHECK_KEY` | 公文审查 Workflow | Dify → 应用 → API 访问 |\n| `DIFY_APP_DOC_OPTIMIZE_KEY` | 公文优化 Workflow | Dify → 应用 → API 访问 |\n| `DIFY_APP_QA_CHAT_KEY` | RAG 问答 Chat App | Dify → 应用 → API 访问 |\n| `DIFY_APP_ENTITY_EXTRACT_KEY` | 实体抽取 Workflow | Dify → 应用 → API 访问 |\n\n> ⚠️ 每个 Dify 应用/知识库有独立 API Key，不可混用。\n\n## 基地址配置\n```python\n# .env 配置项\nDIFY_BASE_URL=http://localhost/v1          # Dify API 基地址\nDIFY_DATASET_API_KEY=dataset-xxx           # 知识库 API Key\nDIFY_APP_DOC_DRAFT_KEY=app-xxx             # 公文起草 App Key\nDIFY_APP_DOC_CHECK_KEY=app-xxx             # 公文审查 App Key\nDIFY_APP_DOC_OPTIMIZE_KEY=app-xxx          # 公文优化 App Key\nDIFY_APP_QA_CHAT_KEY=app-xxx               # RAG 问答 App Key\nDIFY_APP_ENTITY_EXTRACT_KEY=app-xxx        # 实体抽取 App Key\nDIFY_TIMEOUT=120                           # 请求超时(秒)\nDIFY_MAX_RETRIES=3                         # 最大重试次数\nDIFY_MAX_FILE_SIZE=15728640                # 最大文件大小 15MB\n```\n\n## SSE 流式事件格式（通用）\nDify 的 streaming 响应遵循 Server-Sent Events (SSE) 规范：\n```\ndata: {\"event\": \"event_type\", \"...\": \"...\"}\n```\n\n### Workflow SSE 事件类型\n| event | 含义 | 关键字段 |\n|-------|------|----------|\n| `workflow_started` | 工作流开始执行 | `task_id`, `workflow_run_id` |\n| `node_started` | 节点开始执行 | `node_id`, `node_type`, `title` |\n| `node_finished` | 节点执行完成 | `node_id`, `outputs`, `status`, `elapsed_time` |\n| `text_chunk` | 文本片段（LLM 流式输出） | `text` |\n| `workflow_finished` | 工作流执行完成 | `outputs`, `status`, `total_tokens`, `elapsed_time` |\n| `error` | 执行异常 | `message`, `code` |\n| `ping` | 心跳保活 | 无 |\n\n### Chat SSE 事件类型\n| event | 含义 | 关键字段 |\n|-------|------|----------|\n| `message` | 文本块增量 | `answer`（增量文本） |\n| `message_end` | 消息完成 | `metadata.retriever_resources`（引用来源） |\n| `message_file` | 文件类型输出 | `type`, `url` |\n| `error` | 错误 | `message`, `code` |\n| `ping` | 心跳保活 | 无 |\n\n## 错误码映射（Dify → GovAI）\n| Dify 错误 | HTTP 状态码 | GovAI 映射错误码 | 处理策略 |\n|-----------|------------|-----------------|----------|\n| `no_file_uploaded` | 400 | 4002 | 前端提示重新上传 |\n| `too_many_files` | 400 | 4002 | 限制单文件上传 |\n| `file_too_large` | 413 | 4002 | 前端提示文件过大 |\n| `unsupported_file_type` | 415 | 4002 | 前端限制文件类型 |\n| `high_quality_dataset_only` | 400 | 4001 | 日志记录+管理员通知 |\n| `dataset_not_initialized` | 400 | 4001 | 轮询等待后重试 |\n| `archived_document_immutable` | 403 | 4001 | 前端提示文档已归档 |\n| `dataset_name_duplicate` | 409 | 1003 | 前端提示名称重复 |\n| `document_indexing` | 400 | 4001 | 前端提示正在索引中 |\n| `invalid_metadata` | 400 | 1001 | 校验后重试 |\n| 网络超时 | - | 4001 | 重试3次后降级 |\n| 429 Rate Limit | 429 | 4001 | 退避重试(指数退避) |\n| 5xx 服务器错误 | 5xx | 4001 | 重试+告警 |\n\n## 支持的文件类型\n| 类型 | 扩展名 |\n|------|--------|\n| 纯文本 | `.txt`, `.md`, `.markdown` |\n| 文档 | `.pdf`, `.docx`, `.xlsx`, `.csv` |\n| 网页 | `.html`, `.htm` |\n\n> 文件大小限制：单文件 ≤ 15MB\n",
    "version": "1.0.0",
    "contact": {
      "name": "GovAI Dev Team"
    },
    "license": {
      "name": "Proprietary"
    }
  },
  "tags": [
    {
      "name": "Dataset"
    },
    {
      "name": "Document"
    },
    {
      "name": "Segment"
    },
    {
      "name": "Retrieval"
    },
    {
      "name": "Workflow"
    },
    {
      "name": "Chat"
    }
  ],
  "paths": {
    "/datasets": {
      "post": {
        "summary": "创建空知识库",
        "deprecated": false,
        "description": "创建一个空的 Dify 知识库（Dataset）。\n\n**GovAI 调用场景：**\n- 后端A 创建 `kb_collections` 记录时，后端B 同步调用此接口在 Dify 中创建对应 Dataset\n- 返回的 `id` 写入 `kb_collections.dify_dataset_id`\n\n**调用时机：**\n```\nPOST /kb/collections（前端）\n  → 后端A：PgSQL INSERT kb_collections\n  → 后端B：Dify POST /datasets\n  → 后端A：回写 dify_dataset_id\n```\n",
        "operationId": "createDataset",
        "tags": [
          "Dataset"
        ],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateDatasetRequest"
              },
              "example": {
                "name": "政策法规知识库",
                "description": "包含国家及地方政策法规文件",
                "permission": "only_me",
                "indexing_technique": "high_quality"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "创建成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DatasetResponse"
                },
                "example": {
                  "id": "d290f1ee-6c54-4b01-90e6-d701748f0851",
                  "name": "政策法规知识库",
                  "description": "包含国家及地方政策法规文件",
                  "provider": "vendor",
                  "permission": "only_me",
                  "data_source_type": null,
                  "indexing_technique": "high_quality",
                  "app_count": 0,
                  "document_count": 0,
                  "word_count": 0,
                  "created_by": "",
                  "created_at": 1695636173,
                  "updated_by": "",
                  "updated_at": 1695636173,
                  "embedding_model": null,
                  "embedding_model_provider": null,
                  "embedding_available": null
                }
              }
            },
            "headers": {}
          },
          "409": {
            "description": "知识库名称重复",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DifyError"
                },
                "example": {
                  "code": "dataset_name_duplicate",
                  "message": "The dataset name already exists. Please modify your dataset name.",
                  "status": 409
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      },
      "get": {
        "summary": "获取知识库列表",
        "deprecated": false,
        "description": "获取当前账号可见的所有知识库列表（分页）。\n\n**GovAI 调用场景：**\n- 定期对账：比对 PgSQL `kb_collections` 与 Dify Dataset 列表，清理孤儿数据\n- 调试/运维：验证 Dify 侧数据状态\n",
        "operationId": "listDatasets",
        "tags": [
          "Dataset"
        ],
        "parameters": [
          {
            "name": "page",
            "in": "query",
            "description": "页码",
            "required": false,
            "schema": {
              "type": "integer",
              "default": 1,
              "minimum": 1
            }
          },
          {
            "name": "limit",
            "in": "query",
            "description": "每页条数",
            "required": false,
            "schema": {
              "type": "integer",
              "default": 20,
              "minimum": 1,
              "maximum": 100
            }
          }
        ],
        "responses": {
          "200": {
            "description": "获取成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DatasetListResponse"
                },
                "example": {
                  "data": [
                    {
                      "id": "d290f1ee-6c54-4b01-90e6-d701748f0851",
                      "name": "政策法规知识库",
                      "description": "国家政策法规",
                      "permission": "only_me",
                      "data_source_type": "upload_file",
                      "indexing_technique": "high_quality",
                      "app_count": 2,
                      "document_count": 10,
                      "word_count": 12000,
                      "created_by": "",
                      "created_at": "",
                      "updated_by": "",
                      "updated_at": ""
                    }
                  ],
                  "has_more": true,
                  "limit": 20,
                  "total": 50,
                  "page": 1
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    },
    "/datasets/{dataset_id}": {
      "delete": {
        "summary": "删除知识库",
        "deprecated": false,
        "description": "删除整个 Dify 知识库及其中所有文档。**此操作不可逆。**\n\n**GovAI 调用场景：**\n- 后端A 删除 `kb_collections` 时，先调用后端B 删除 Dify Dataset\n- 仅当 Dify 删除成功后，才删除 PgSQL 记录\n\n**调用时序：**\n```\nDELETE /kb/collections/{id}（前端）\n  → 后端B：Dify DELETE /datasets/{dataset_id}    ← ① 先删Dify\n  → 后端A：PgSQL DELETE kb_collections            ← ② 再删PgSQL\n  → 后端A：PgSQL DELETE kb_files WHERE collection_id = ...\n```\n",
        "operationId": "deleteDataset",
        "tags": [
          "Dataset"
        ],
        "parameters": [
          {
            "name": "dataset_id",
            "in": "path",
            "description": "Dify 知识库 ID。\n来源：`POST /datasets` 的返回值，存储在 `kb_collections.dify_dataset_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "responses": {
          "204": {
            "description": "删除成功（无响应体）",
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    },
    "/datasets/{dataset_id}/document/create-by-file": {
      "post": {
        "summary": "通过文件创建文档",
        "deprecated": false,
        "description": "上传文件到指定 Dify 知识库，用于 **RAG 检索问答**。Dify 将自动执行分块、向量化、索引。\n\n> ⚠️ **注意区分**：此接口用于 **知识库文档上传**（RAG 问答），不是 **公文导入**（文档管理）。\n> - 知识库上传：调用此 Dify API，数据存储在 `kb_files` 表和 Dify 向量数据库\n> - 公文导入：调用 FastAPI `/documents/import`，数据存储在 `documents` 表\n> 详见文档顶部「文件上传场景区分」章节。\n\n**GovAI 调用场景：**\n- 用户在知识库管理页面上传文件时触发\n- 这是知识库文件同步的**核心接口**\n\n**完整调用流程：**\n```\nPOST /kb/files/upload（前端，multipart 文件）\n  → 后端A：PgSQL INSERT kb_files (status='uploading')\n  → 后端B：Dify POST /datasets/{id}/document/create-by-file\n  → 后端A：回写 dify_document_id + dify_batch_id\n  → 后端A：更新 status='indexing'\n  → [后端A/B 可选轮询 indexing-status]\n  → 最终更新 status='indexed'\n```\n\n**请求格式：** `multipart/form-data`\n- `data` 字段：JSON 字符串，包含索引配置\n- `file` 字段：文件二进制数据\n\n**索引配置说明：**\n| 参数 | 说明 |\n|------|------|\n| `indexing_technique` | `high_quality`（推荐）或 `economy` |\n| `process_rule.mode` | `automatic`（推荐）或 `custom` |\n| `process_rule.rules.pre_processing_rules` | 预处理规则数组 |\n| `process_rule.rules.segmentation` | 分块策略 |\n",
        "operationId": "createDocumentByFile",
        "tags": [
          "Document"
        ],
        "parameters": [
          {
            "name": "dataset_id",
            "in": "path",
            "description": "Dify 知识库 ID。\n来源：`POST /datasets` 的返回值，存储在 `kb_collections.dify_dataset_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "requestBody": {
          "content": {
            "multipart/form-data": {
              "schema": {
                "type": "object",
                "properties": {
                  "data": {
                    "type": "string",
                    "description": "JSON 字符串，包含文档处理配置。示例：\n```json\n{\n  \"indexing_technique\": \"high_quality\",\n  \"process_rule\": {\n    \"mode\": \"automatic\"\n  }\n}\n```\n或自定义模式：\n```json\n{\n  \"indexing_technique\": \"high_quality\",\n  \"process_rule\": {\n    \"mode\": \"custom\",\n    \"rules\": {\n      \"pre_processing_rules\": [\n        {\"id\": \"remove_extra_spaces\", \"enabled\": true},\n        {\"id\": \"remove_urls_emails\", \"enabled\": true}\n      ],\n      \"segmentation\": {\n        \"separator\": \"###\",\n        \"max_tokens\": 500\n      }\n    }\n  }\n}\n```\n",
                    "example": ""
                  },
                  "file": {
                    "type": "string",
                    "format": "binary",
                    "description": "上传的文件。支持格式：\ntxt, md, markdown, pdf, html, htm, xlsx, docx, csv\n单文件最大 15MB\n",
                    "example": ""
                  }
                },
                "required": [
                  "data",
                  "file"
                ]
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "文档创建成功（异步索引中）",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DocumentResponse"
                },
                "example": {
                  "document": {
                    "id": "a8c6c36f-9f5d-4d7a-8472-f5d7b75d71d2",
                    "position": 1,
                    "data_source_type": "upload_file",
                    "data_source_info": {
                      "upload_file_id": "f5d7b75d-71d2-4d7a-8472-a8c6c36f9f5d"
                    },
                    "dataset_process_rule_id": "rule-uuid",
                    "name": "数据安全法.pdf",
                    "created_from": "api",
                    "created_by": "",
                    "created_at": 1695308667,
                    "tokens": 0,
                    "indexing_status": "waiting",
                    "error": null,
                    "enabled": true,
                    "disabled_at": null,
                    "disabled_by": null,
                    "archived": false,
                    "display_status": "queuing",
                    "word_count": 0,
                    "hit_count": 0,
                    "doc_form": "text_model"
                  },
                  "batch": "20230921150427533684"
                }
              }
            },
            "headers": {}
          },
          "400": {
            "description": "请求错误",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DifyError"
                },
                "examples": {
                  "no_file": {
                    "summary": "未上传文件",
                    "value": {
                      "code": "no_file_uploaded",
                      "message": "Please upload your file.",
                      "status": 400
                    }
                  },
                  "too_many": {
                    "summary": "文件过多",
                    "value": {
                      "code": "too_many_files",
                      "message": "Only one file is allowed.",
                      "status": 400
                    }
                  }
                }
              }
            },
            "headers": {}
          },
          "413": {
            "description": "文件过大",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DifyError"
                },
                "example": {
                  "code": "file_too_large",
                  "message": "File size exceeded.",
                  "status": 413
                }
              }
            },
            "headers": {}
          },
          "415": {
            "description": "不支持的文件类型",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DifyError"
                },
                "example": {
                  "code": "unsupported_file_type",
                  "message": "File type not allowed.",
                  "status": 415
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    },
    "/datasets/{dataset_id}/document/create_by_text": {
      "post": {
        "summary": "通过文本创建文档",
        "deprecated": false,
        "description": "以纯文本方式在指定知识库中创建文档。\n\n**GovAI 调用场景：**\n- QA 问答对批量导入到知识库\n- 将公文内容同步到知识库（可选功能）\n- 手动创建知识库文档（不通过文件上传）\n",
        "operationId": "createDocumentByText",
        "tags": [
          "Document"
        ],
        "parameters": [
          {
            "name": "dataset_id",
            "in": "path",
            "description": "Dify 知识库 ID。\n来源：`POST /datasets` 的返回值，存储在 `kb_collections.dify_dataset_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateDocumentByTextRequest"
              },
              "example": {
                "name": "QA问答对-网络安全",
                "text": "问题：什么是数据分类分级？\n答案：数据分类分级是指...",
                "indexing_technique": "high_quality",
                "process_rule": {
                  "mode": "automatic"
                }
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "文档创建成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DocumentResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    },
    "/datasets/{dataset_id}/documents/{document_id}/update-by-file": {
      "post": {
        "summary": "通过文件更新文档",
        "deprecated": false,
        "description": "用新文件替换已有文档内容，Dify 将重新执行分块和索引。\n\n**GovAI 调用场景：**\n- 用户在知识库页面重新上传文件（版本更新）\n- 文件内容变更后需要重新索引\n",
        "operationId": "updateDocumentByFile",
        "tags": [
          "Document"
        ],
        "parameters": [
          {
            "name": "dataset_id",
            "in": "path",
            "description": "Dify 知识库 ID。\n来源：`POST /datasets` 的返回值，存储在 `kb_collections.dify_dataset_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "document_id",
            "in": "path",
            "description": "Dify 文档 ID。\n来源：`POST /document/create-by-file` 的返回值，存储在 `kb_files.dify_document_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "requestBody": {
          "content": {
            "multipart/form-data": {
              "schema": {
                "type": "object",
                "properties": {
                  "data": {
                    "type": "string",
                    "description": "JSON 字符串，包含文档名和处理配置",
                    "example": ""
                  },
                  "file": {
                    "type": "string",
                    "format": "binary",
                    "example": ""
                  }
                },
                "required": [
                  "data",
                  "file"
                ]
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "更新成功（异步重新索引中）",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DocumentResponse"
                },
                "example": {
                  "document": {
                    "id": "a8c6c36f-9f5d-4d7a-8472-f5d7b75d71d2",
                    "position": 1,
                    "data_source_type": "upload_file",
                    "name": "数据安全法_v2.pdf",
                    "created_from": "api",
                    "indexing_status": "waiting",
                    "display_status": "queuing",
                    "doc_form": "text_model"
                  },
                  "batch": "20230921150427533684"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    },
    "/datasets/{dataset_id}/documents/{document_id}/update_by_text": {
      "post": {
        "summary": "通过文本更新文档",
        "deprecated": false,
        "description": "用新文本替换已有文档内容。\n\n**GovAI 调用场景：**\n- QA 问答对内容修改后同步更新到 Dify 知识库\n",
        "operationId": "updateDocumentByText",
        "tags": [
          "Document"
        ],
        "parameters": [
          {
            "name": "dataset_id",
            "in": "path",
            "description": "Dify 知识库 ID。\n来源：`POST /datasets` 的返回值，存储在 `kb_collections.dify_dataset_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "document_id",
            "in": "path",
            "description": "Dify 文档 ID。\n来源：`POST /document/create-by-file` 的返回值，存储在 `kb_files.dify_document_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "文档名称"
                  },
                  "text": {
                    "type": "string",
                    "description": "文档文本内容"
                  }
                }
              },
              "example": {
                "name": "QA-网络安全-v2",
                "text": "更新后的问答内容..."
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "更新成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DocumentResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    },
    "/datasets/{dataset_id}/documents": {
      "get": {
        "summary": "获取知识库文档列表",
        "deprecated": false,
        "description": "获取指定知识库中的文档列表（分页）。\n\n**GovAI 调用场景：**\n- 定期对账：比对 PgSQL `kb_files` 与 Dify 文档列表\n- 查询文档索引状态\n- 调试/运维\n",
        "operationId": "listDocuments",
        "tags": [
          "Document"
        ],
        "parameters": [
          {
            "name": "dataset_id",
            "in": "path",
            "description": "Dify 知识库 ID。\n来源：`POST /datasets` 的返回值，存储在 `kb_collections.dify_dataset_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "page",
            "in": "query",
            "description": "",
            "required": false,
            "schema": {
              "type": "integer",
              "default": 1
            }
          },
          {
            "name": "limit",
            "in": "query",
            "description": "",
            "required": false,
            "schema": {
              "type": "integer",
              "default": 20
            }
          }
        ],
        "responses": {
          "200": {
            "description": "获取成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DocumentListResponse"
                },
                "example": {
                  "data": [
                    {
                      "id": "a8c6c36f-9f5d-4d7a-8472-f5d7b75d71d2",
                      "position": 1,
                      "data_source_type": "file_upload",
                      "data_source_info": null,
                      "dataset_process_rule_id": null,
                      "name": "数据安全法.pdf",
                      "created_from": "api",
                      "created_by": "",
                      "created_at": 1681623639,
                      "tokens": 5800,
                      "indexing_status": "completed",
                      "error": null,
                      "enabled": true,
                      "disabled_at": null,
                      "disabled_by": null,
                      "archived": false
                    }
                  ],
                  "has_more": false,
                  "limit": 20,
                  "total": 9,
                  "page": 1
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    },
    "/datasets/{dataset_id}/documents/{document_id}": {
      "delete": {
        "summary": "删除文档",
        "deprecated": false,
        "description": "从知识库中删除指定文档及其所有分片。**不可逆操作。**\n\n**GovAI 调用流程：**\n```\nDELETE /kb/files/{id}（前端）\n  → 后端A：查询 kb_files 获取 dify_document_id 和 collection.dify_dataset_id\n  → 后端B：Dify DELETE /datasets/{dataset_id}/documents/{document_id}  ← ① 先删Dify\n  → 后端A：PgSQL DELETE kb_files WHERE id = ...                        ← ② 再删PgSQL\n```\n",
        "operationId": "deleteDocument",
        "tags": [
          "Document"
        ],
        "parameters": [
          {
            "name": "dataset_id",
            "in": "path",
            "description": "Dify 知识库 ID。\n来源：`POST /datasets` 的返回值，存储在 `kb_collections.dify_dataset_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "document_id",
            "in": "path",
            "description": "Dify 文档 ID。\n来源：`POST /document/create-by-file` 的返回值，存储在 `kb_files.dify_document_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "删除成功",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "result": {
                      "type": "string",
                      "example": "success"
                    }
                  }
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    },
    "/datasets/{dataset_id}/documents/{batch}/indexing-status": {
      "get": {
        "summary": "查询文档索引进度",
        "deprecated": false,
        "description": "通过 batch ID 查询文档的向量化索引进度。\n\n**GovAI 调用场景：**\n- 文件上传后轮询索引状态\n- 前端展示索引进度条\n- 更新 `kb_files.status`（indexing → indexed / failed）\n\n**轮询策略：**\n```python\n# 推荐轮询间隔\nPOLL_INTERVAL = 3        # 秒\nMAX_POLL_COUNT = 60      # 最多轮询 60 次（3分钟）\nPOLL_TIMEOUT = 180       # 总超时 3 分钟\n\n# 索引状态流转\nwaiting → indexing → completed\n                  → paused\n                  → error\n```\n\n**状态映射到 kb_files.status：**\n| Dify indexing_status | GovAI kb_file_status |\n|---------------------|---------------------|\n| `waiting` | `indexing` |\n| `indexing` | `indexing` |\n| `completed` | `indexed` |\n| `paused` | `failed` |\n| `error` | `failed` |\n",
        "operationId": "getDocumentIndexingStatus",
        "tags": [
          "Document"
        ],
        "parameters": [
          {
            "name": "dataset_id",
            "in": "path",
            "description": "Dify 知识库 ID。\n来源：`POST /datasets` 的返回值，存储在 `kb_collections.dify_dataset_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "batch",
            "in": "path",
            "description": "文档创建时返回的批次 ID。\n来源：`POST /document/create-by-file` 响应中的 `batch` 字段\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "索引状态",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/IndexingStatusResponse"
                },
                "example": {
                  "data": [
                    {
                      "id": "a8c6c36f-9f5d-4d7a-8472-f5d7b75d71d2",
                      "indexing_status": "indexing",
                      "processing_started_at": 1681623462,
                      "parsing_completed_at": 1681623462,
                      "cleaning_completed_at": 1681623462,
                      "splitting_completed_at": 1681623462,
                      "completed_at": null,
                      "paused_at": null,
                      "error": null,
                      "stopped_at": null,
                      "completed_segments": 24,
                      "total_segments": 100
                    }
                  ]
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    },
    "/datasets/{dataset_id}/documents/{document_id}/segments": {
      "post": {
        "summary": "添加文档分片",
        "deprecated": false,
        "description": "向指定文档手动添加分片（Chunk）。\n\n**GovAI 调用场景：**\n- QA 问答对手动写入知识库（问题作为 content，答案作为 answer）\n- 特殊内容手动分片\n",
        "operationId": "addSegments",
        "tags": [
          "Segment"
        ],
        "parameters": [
          {
            "name": "dataset_id",
            "in": "path",
            "description": "Dify 知识库 ID。\n来源：`POST /datasets` 的返回值，存储在 `kb_collections.dify_dataset_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "document_id",
            "in": "path",
            "description": "Dify 文档 ID。\n来源：`POST /document/create-by-file` 的返回值，存储在 `kb_files.dify_document_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/AddSegmentsRequest"
              },
              "example": {
                "segments": [
                  {
                    "content": "什么是数据分类分级？",
                    "answer": "数据分类分级是指根据数据在经济社会发展中的重要程度...",
                    "keywords": [
                      "数据分类",
                      "分级",
                      "数据安全"
                    ]
                  }
                ]
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "添加成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SegmentListResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      },
      "get": {
        "summary": "获取文档分片列表",
        "deprecated": false,
        "description": "获取指定文档的所有分片。\n\n**GovAI 调用场景：**\n- 调试：检查文档分片质量\n- 运维：验证分片是否正确\n",
        "operationId": "getSegments",
        "tags": [
          "Segment"
        ],
        "parameters": [
          {
            "name": "dataset_id",
            "in": "path",
            "description": "Dify 知识库 ID。\n来源：`POST /datasets` 的返回值，存储在 `kb_collections.dify_dataset_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "document_id",
            "in": "path",
            "description": "Dify 文档 ID。\n来源：`POST /document/create-by-file` 的返回值，存储在 `kb_files.dify_document_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "分片列表",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SegmentListResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    },
    "/datasets/{dataset_id}/documents/{document_id}/segments/{segment_id}": {
      "post": {
        "summary": "更新文档分片",
        "deprecated": false,
        "description": "更新指定分片的内容、答案或关键词。\n",
        "operationId": "updateSegment",
        "tags": [
          "Segment"
        ],
        "parameters": [
          {
            "name": "dataset_id",
            "in": "path",
            "description": "Dify 知识库 ID。\n来源：`POST /datasets` 的返回值，存储在 `kb_collections.dify_dataset_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "document_id",
            "in": "path",
            "description": "Dify 文档 ID。\n来源：`POST /document/create-by-file` 的返回值，存储在 `kb_files.dify_document_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "segment_id",
            "in": "path",
            "description": "Dify 文档分片 ID",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "segment": {
                    "type": "object",
                    "properties": {
                      "content": {
                        "type": "string"
                      },
                      "answer": {
                        "type": "string"
                      },
                      "keywords": {
                        "type": "array",
                        "items": {
                          "type": "string"
                        }
                      },
                      "enabled": {
                        "type": "boolean"
                      }
                    }
                  }
                }
              },
              "example": {
                "segment": {
                  "content": "更新后的分片内容",
                  "answer": "更新后的答案",
                  "keywords": [
                    "关键词1",
                    "关键词2"
                  ],
                  "enabled": true
                }
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "更新成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SegmentListResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      },
      "delete": {
        "summary": "删除文档分片",
        "deprecated": false,
        "description": "",
        "operationId": "deleteSegment",
        "tags": [
          "Segment"
        ],
        "parameters": [
          {
            "name": "dataset_id",
            "in": "path",
            "description": "Dify 知识库 ID。\n来源：`POST /datasets` 的返回值，存储在 `kb_collections.dify_dataset_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "document_id",
            "in": "path",
            "description": "Dify 文档 ID。\n来源：`POST /document/create-by-file` 的返回值，存储在 `kb_files.dify_document_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "segment_id",
            "in": "path",
            "description": "Dify 文档分片 ID",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "删除成功",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "result": {
                      "type": "string",
                      "example": "success"
                    }
                  }
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    },
    "/datasets/{dataset_id}/retrieve": {
      "post": {
        "summary": "从知识库检索",
        "deprecated": false,
        "description": "直接对知识库执行向量/关键词/混合检索。\n\n**GovAI 调用场景：**\n- 调试 RAG 检索效果\n- 独立检索场景（不经过 LLM 生成）\n- 公文起草时预检索相关政策（可选）\n\n**检索方法：**\n| search_method | 说明 |\n|---------------|------|\n| `keyword_search` | 关键词检索 |\n| `semantic_search` | 向量语义检索 |\n| `full_text_search` | 全文检索 |\n| `hybrid_search` | 混合检索（推荐） |\n",
        "operationId": "retrieveFromDataset",
        "tags": [
          "Retrieval"
        ],
        "parameters": [
          {
            "name": "dataset_id",
            "in": "path",
            "description": "Dify 知识库 ID。\n来源：`POST /datasets` 的返回值，存储在 `kb_collections.dify_dataset_id`\n",
            "required": true,
            "example": "",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/RetrievalRequest"
              },
              "example": {
                "query": "数据分类分级的要求是什么",
                "retrieval_model": {
                  "search_method": "hybrid_search",
                  "reranking_enable": true,
                  "reranking_mode": null,
                  "reranking_model": {
                    "reranking_provider_name": "",
                    "reranking_model_name": ""
                  },
                  "weights": null,
                  "top_k": 5,
                  "score_threshold_enabled": true,
                  "score_threshold": 0.5
                }
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "检索结果",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RetrievalResponse"
                },
                "example": {
                  "query": {
                    "content": "数据分类分级的要求是什么"
                  },
                  "records": [
                    {
                      "segment": {
                        "id": "7fa6f24f-8679-48b3-bc9d-bdf28d73f218",
                        "position": 1,
                        "document_id": "a8c6c36f-9f5d-4d7a-8472-f5d7b75d71d2",
                        "content": "第二十一条 国家建立数据分类分级保护制度...",
                        "answer": null,
                        "word_count": 847,
                        "tokens": 280,
                        "keywords": [
                          "分类",
                          "分级",
                          "保护",
                          "数据安全"
                        ],
                        "index_node_id": "39dd8443-d960-45a8-bb46-7275ad7fbc8e",
                        "hit_count": 0,
                        "enabled": true,
                        "status": "completed",
                        "created_at": 1728734540,
                        "document": {
                          "id": "a8c6c36f-9f5d-4d7a-8472-f5d7b75d71d2",
                          "data_source_type": "upload_file",
                          "name": "数据安全法.pdf",
                          "doc_type": null
                        }
                      },
                      "score": 0.89
                    }
                  ]
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    },
    "/workflows/run": {
      "post": {
        "summary": "执行工作流",
        "deprecated": false,
        "description": "执行 Dify Workflow 应用。GovAI 共有 **4 个 Workflow 应用**，\n每个使用独立的 API Key，通过不同的 `inputs` 参数区分。\n\n### Workflow 1：公文起草（doc-draft-workflow）\n**API Key：** `DIFY_APP_DOC_DRAFT_KEY`\n\n| 输入变量 | 类型 | 必填 | 说明 |\n|----------|------|------|------|\n| `template_content` | string | 是 | 公文模板文本（含 `{{placeholder}}` 占位符） |\n| `user_requirement` | string | 是 | 用户起草要求（如\"撰写关于数据安全的通知\"） |\n| `reference_materials` | string | 否 | 参考素材文本（从素材库选取） |\n\n**输出变量：**\n```json\n{\n  \"generated_text\": \"关于加强数据安全管理的通知\\n\\n各部门：...\",\n  \"sections\": [\n    {\"title\": \"标题\", \"content\": \"关于加强数据安全管理的通知\"},\n    {\"title\": \"正文\", \"content\": \"各部门：为贯彻落实...\"}\n  ],\n  \"tokens_used\": 1500\n}\n```\n\n---\n\n### Workflow 2：公文审查（doc-check-workflow）\n**API Key：** `DIFY_APP_DOC_CHECK_KEY`\n\n| 输入变量 | 类型 | 必填 | 说明 |\n|----------|------|------|------|\n| `content` | string | 是 | 待审查的公文全文 |\n\n**输出变量：**\n```json\n{\n  \"typos\": [\n    {\"position\": \"第2段第3行\", \"original\": \"做\", \"suggestion\": \"作\", \"reason\": \"用词不当\"}\n  ],\n  \"grammar_issues\": [\n    {\"position\": \"第1段第5行\", \"text\": \"...\", \"suggestion\": \"...\", \"severity\": \"warning\"}\n  ],\n  \"sensitive_words\": [\n    {\"word\": \"xxx\", \"position\": \"第3段第1行\", \"suggestion\": \"建议替换为yyy\"}\n  ],\n  \"format_issues\": [\n    {\"type\": \"标题格式\", \"description\": \"标题应居中\", \"suggestion\": \"调整为居中格式\"}\n  ],\n  \"overall_score\": 85,\n  \"summary\": \"文档整体质量良好，发现2处错别字和1处格式问题\"\n}\n```\n\n---\n\n### Workflow 3：公文优化（doc-optimize-workflow）\n**API Key：** `DIFY_APP_DOC_OPTIMIZE_KEY`\n\n| 输入变量 | 类型 | 必填 | 说明 |\n|----------|------|------|------|\n| `content` | string | 是 | 待优化的公文全文 |\n| `optimization_focus` | string | 否 | 优化重点（如\"语言规范性\"\"逻辑连贯性\"） |\n\n**输出变量：**\n```json\n{\n  \"optimized_text\": \"优化后的公文全文...\",\n  \"changes\": [\n    {\"type\": \"wording\", \"original\": \"...\", \"optimized\": \"...\", \"reason\": \"更加规范\"},\n    {\"type\": \"structure\", \"original\": \"...\", \"optimized\": \"...\", \"reason\": \"逻辑更清晰\"}\n  ],\n  \"tokens_used\": 2000\n}\n```\n\n---\n\n### Workflow 4：实体抽取（entity-extract-workflow）\n**API Key：** `DIFY_APP_ENTITY_EXTRACT_KEY`\n\n| 输入变量 | 类型 | 必填 | 说明 |\n|----------|------|------|------|\n| `text` | string | 是 | 待抽取实体的文本内容 |\n| `source_doc_id` | string | 否 | 来源文档 ID（用于溯源） |\n\n**输出变量：**\n```json\n{\n  \"entities\": [\n    {\"name\": \"数据安全法\", \"type\": \"法规\", \"description\": \"2021年实施的数据安全基本法\"},\n    {\"name\": \"分类分级\", \"type\": \"概念\", \"description\": \"数据保护的核心制度之一\"},\n    {\"name\": \"网信办\", \"type\": \"机构\", \"description\": \"国家互联网信息办公室\"}\n  ],\n  \"relationships\": [\n    {\"source\": \"数据安全法\", \"relation\": \"规定\", \"target\": \"分类分级\", \"weight\": 0.95},\n    {\"source\": \"网信办\", \"relation\": \"执法\", \"target\": \"数据安全法\", \"weight\": 0.85}\n  ]\n}\n```\n\n> 后端B 将抽取结果写入 PgSQL Apache AGE 图数据库。\n\n---\n\n### 通用请求参数\n",
        "operationId": "runWorkflow",
        "tags": [
          "Workflow"
        ],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/WorkflowRunRequest"
              },
              "examples": {
                "doc_draft": {
                  "value": {
                    "inputs": {
                      "template_content": "关于{{主题}}的{{类型}}\n\n各{{范围}}：\n\n  为{{目的}}...",
                      "user_requirement": "撰写一份关于加强数据安全管理的通知",
                      "reference_materials": "根据《数据安全法》第二十一条规定..."
                    },
                    "response_mode": "blocking",
                    "user": "govai-user-uuid"
                  },
                  "summary": "公文起草"
                },
                "doc_check": {
                  "value": {
                    "inputs": {
                      "content": "关于加强数据安全管理的通知\n\n各部门：\n\n  做好数据安全管理工作..."
                    },
                    "response_mode": "blocking",
                    "user": "govai-user-uuid"
                  },
                  "summary": "公文审查"
                },
                "doc_optimize": {
                  "value": {
                    "inputs": {
                      "content": "待优化的公文全文...",
                      "optimization_focus": "语言规范性"
                    },
                    "response_mode": "blocking",
                    "user": "govai-user-uuid"
                  },
                  "summary": "公文优化"
                },
                "entity_extract": {
                  "value": {
                    "inputs": {
                      "text": "《数据安全法》第二十一条规定国家建立数据分类分级保护制度...",
                      "source_doc_id": "k1"
                    },
                    "response_mode": "blocking",
                    "user": "govai-user-uuid"
                  },
                  "summary": "实体抽取"
                }
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "执行成功。\n\n**blocking 模式**：等待执行完成后返回完整结果（JSON 格式）。\n\n**streaming 模式**：返回 SSE 事件流（text/event-stream 格式）。\n每个事件以 `data: {...}` 格式发送，事件类型参见 WorkflowSSEEvent Schema。\n\n**SSE 事件流示例：**\n```\ndata: {\"event\": \"workflow_started\", \"task_id\": \"task-xxx\", \"workflow_run_id\": \"wfr-xxx\"}\n\ndata: {\"event\": \"node_started\", \"node_id\": \"llm-1\", \"node_type\": \"llm\", \"title\": \"公文起草\"}\n\ndata: {\"event\": \"text_chunk\", \"text\": \"关于加强\"}\n\ndata: {\"event\": \"text_chunk\", \"text\": \"数据安全\"}\n\ndata: {\"event\": \"node_finished\", \"node_id\": \"llm-1\", \"outputs\": {...}, \"status\": \"succeeded\", \"elapsed_time\": 8.5}\n\ndata: {\"event\": \"workflow_finished\", \"outputs\": {\"generated_text\": \"...\"}, \"status\": \"succeeded\", \"elapsed_time\": 12.5, \"total_tokens\": 1500}\n```\n\n**GovAI 使用建议：**\n- 公文起草/审查/优化：推荐使用 `blocking` 模式（简单可靠）\n- 实体抽取：推荐使用 `blocking` 模式\n- 如需实时展示进度：可使用 `streaming` 模式\n",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WorkflowBlockingResponse"
                },
                "example": {
                  "workflow_run_id": "wfr-d290f1ee-6c54-4b01-90e6",
                  "task_id": "task-a8c6c36f-9f5d",
                  "data": {
                    "id": "wfr-d290f1ee-6c54-4b01-90e6",
                    "workflow_id": "wf-xxx",
                    "status": "succeeded",
                    "outputs": {
                      "generated_text": "关于加强数据安全管理的通知..."
                    },
                    "error": null,
                    "elapsed_time": 12.5,
                    "total_tokens": 1500,
                    "total_steps": 3,
                    "created_at": 1695308667,
                    "finished_at": 1695308680
                  }
                }
              },
              "text/event-stream": {
                "schema": {
                  "type": "string",
                  "description": "SSE 事件流。每个事件格式参见 WorkflowSSEEvent Schema。\n\n事件以 `data: {...}` 格式发送，客户端需要解析 JSON。"
                },
                "examples": {
                  "workflow_stream": {
                    "summary": "工作流流式响应示例",
                    "value": "data: {\"event\": \"workflow_started\", \"task_id\": \"task-a8c6c36f\", \"workflow_run_id\": \"wfr-d290f1ee\"}\n\ndata: {\"event\": \"node_started\", \"node_id\": \"llm-node-1\", \"node_type\": \"llm\", \"title\": \"公文起草 LLM\"}\n\ndata: {\"event\": \"text_chunk\", \"text\": \"关于加强数据安全\"}\n\ndata: {\"event\": \"node_finished\", \"node_id\": \"llm-node-1\", \"outputs\": {\"text\": \"关于加强数据安全管理的通知...\"}, \"status\": \"succeeded\", \"elapsed_time\": 8.5}\n\ndata: {\"event\": \"workflow_finished\", \"outputs\": {\"generated_text\": \"关于加强数据安全管理的通知...\"}, \"status\": \"succeeded\", \"elapsed_time\": 12.5, \"total_tokens\": 1500}\n"
                  }
                }
              }
            },
            "headers": {}
          },
          "400": {
            "description": "请求参数错误",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DifyError"
                },
                "examples": {
                  "invalid_inputs": {
                    "summary": "输入参数缺失",
                    "value": {
                      "code": "invalid_param",
                      "message": "Missing required input: template_content",
                      "status": 400
                    }
                  },
                  "invalid_response_mode": {
                    "summary": "响应模式无效",
                    "value": {
                      "code": "invalid_param",
                      "message": "response_mode must be 'blocking' or 'streaming'",
                      "status": 400
                    }
                  }
                }
              }
            }
          },
          "429": {
            "description": "请求频率限制",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DifyError"
                },
                "example": {
                  "code": "rate_limit_exceeded",
                  "message": "Too many requests. Please try again later.",
                  "status": 429
                }
              }
            }
          },
          "500": {
            "description": "Dify 服务器错误",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DifyError"
                },
                "examples": {
                  "llm_error": {
                    "summary": "LLM 调用失败",
                    "value": {
                      "code": "llm_error",
                      "message": "LLM request failed: timeout",
                      "status": 500
                    }
                  },
                  "workflow_error": {
                    "summary": "工作流执行失败",
                    "value": {
                      "code": "workflow_execution_failed",
                      "message": "Workflow execution failed at node: llm-node-1",
                      "status": 500
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "API Key 无效或缺失",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DifyError"
                },
                "example": {
                  "code": "unauthorized",
                  "message": "Invalid API key",
                  "status": 401
                }
              }
            }
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    },
    "/workflows/tasks/{task_id}/stop": {
      "post": {
        "summary": "停止工作流任务",
        "deprecated": false,
        "description": "停止正在运行的工作流任务。\n\n**GovAI 调用场景：**\n- 用户在公文起草过程中取消操作\n- 超时自动取消\n",
        "operationId": "stopWorkflowTask",
        "tags": [
          "Workflow"
        ],
        "parameters": [
          {
            "name": "task_id",
            "in": "path",
            "description": "任务 ID（来自 workflow_started 事件或 blocking 响应）",
            "required": true,
            "example": "",
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "user"
                ],
                "properties": {
                  "user": {
                    "type": "string",
                    "description": "用户标识"
                  }
                }
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "停止成功",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "result": {
                      "type": "string",
                      "example": "success"
                    }
                  }
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    },
    "/chat-messages": {
      "post": {
        "summary": "发送 RAG 问答消息",
        "deprecated": false,
        "description": "向 Dify Chat 应用发送问答请求，支持 streaming SSE 流式输出。\n\n**GovAI 调用场景：**\n- 智能法规问答模块的核心调用\n- 后端A 的 `POST /chat/send` 在 QA 库未命中时，调用此接口\n\n**完整调用链路：**\n```\n前端 POST /chat/send (SSE)\n  → 后端A：权限检查 + 敏感词前置拦截\n  → 后端A：QA库优先匹配 (qa_service.find_best_match)\n  → [命中] → 直接 SSE 返回 QA 答案\n  → [未命中] → 后端B：Dify POST /chat-messages (streaming)\n    → 后端B：逐块转发 SSE 给后端A\n    → 后端A：保存消息到 chat_messages 表\n    → 后端A：SSE 转发给前端\n```\n\n**请求参数说明：**\n\n| 参数 | 类型 | 必填 | 说明 |\n|------|------|------|------|\n| `inputs` | object | 否 | Dify App 定义的变量（首次对话时传入） |\n| `query` | string | 是 | 用户问题文本 |\n| `response_mode` | string | 是 | 固定 `streaming`（SSE流式） |\n| `conversation_id` | string | 否 | 会话 ID（续接已有对话时传入） |\n| `user` | string | 是 | 用户唯一标识（GovAI user UUID） |\n| `files` | array | 否 | 上传的文件列表（暂不使用） |\n\n**关于 conversation_id：**\n- 首次对话：不传此参数，Dify 返回新的 `conversation_id`\n- 续接对话：传入上次返回的 `conversation_id`\n- GovAI 中：`chat_sessions.dify_conversation_id` 存储此值\n- ⚠️ Dify Service API 的对话与 WebApp 对话隔离\n",
        "operationId": "sendChatMessage",
        "tags": [
          "Chat"
        ],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ChatMessageRequest"
              },
              "example": {
                "inputs": {},
                "query": "数据分类分级的具体要求是什么？",
                "response_mode": "streaming",
                "conversation_id": "",
                "user": "govai-user-d290f1ee"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "**streaming 模式响应（推荐）：**\n\n返回 SSE 事件流，Content-Type 为 `text/event-stream`。\n\n**SSE 事件序列示例：**\n```\nevent: message\ndata: {\"event\": \"message\", \"message_id\": \"msg-xxx\", \"conversation_id\": \"conv-xxx\", \"answer\": \"根据\", \"created_at\": 1695308667}\n\nevent: message\ndata: {\"event\": \"message\", \"message_id\": \"msg-xxx\", \"conversation_id\": \"conv-xxx\", \"answer\": \"《数据安全法》\", \"created_at\": 1695308667}\n\nevent: message\ndata: {\"event\": \"message\", \"message_id\": \"msg-xxx\", \"conversation_id\": \"conv-xxx\", \"answer\": \"第二十一条\", \"created_at\": 1695308667}\n\n...（更多文本片段）\n\nevent: message_end\ndata: {\"event\": \"message_end\", \"message_id\": \"msg-xxx\", \"conversation_id\": \"conv-xxx\", \"metadata\": {\"usage\": {\"prompt_tokens\": 500, \"completion_tokens\": 200, \"total_tokens\": 700}, \"retriever_resources\": [{\"position\": 1, \"dataset_id\": \"ds-xxx\", \"dataset_name\": \"政策法规知识库\", \"document_id\": \"doc-xxx\", \"document_name\": \"数据安全法.pdf\", \"segment_id\": \"seg-xxx\", \"score\": 0.89, \"content\": \"第二十一条 国家建立数据分类分级保护制度...\"}]}}\n```\n\n**关键 SSE 事件详解：**\n\n| event | 作用 | 后端处理 |\n|-------|------|----------|\n| `message` | LLM 逐 token 输出 | 拼接 `answer` 字段 → SSE 转发给前端 |\n| `message_end` | 消息完成信号 | 提取 `retriever_resources` → 构建 citations → 保存 chat_messages |\n| `message_file` | 文件类型输出 | 暂不处理 |\n| `error` | 异常 | 日志记录 + 前端提示 |\n| `ping` | 心跳 | 忽略 |\n",
            "content": {
              "text/event-stream": {
                "schema": {
                  "type": "string",
                  "description": "SSE 事件流"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    },
    "/messages/{message_id}/feedbacks": {
      "post": {
        "summary": "消息反馈（点赞/踩）",
        "deprecated": false,
        "description": "对 Dify 返回的消息进行反馈，用于优化 RAG 效果。\n\n**GovAI 调用场景：**\n- 用户在问答界面点击 👍/👎 时触发\n- 反馈数据帮助 Dify 优化检索和生成质量\n",
        "operationId": "messageFeedback",
        "tags": [
          "Chat"
        ],
        "parameters": [
          {
            "name": "message_id",
            "in": "path",
            "description": "Dify 消息 ID（来自 message 事件的 message_id）",
            "required": true,
            "example": "",
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "rating",
                  "user"
                ],
                "properties": {
                  "rating": {
                    "type": "string",
                    "enum": [
                      "like",
                      "dislike",
                      null
                    ],
                    "description": "like=点赞, dislike=点踩, null=撤销"
                  },
                  "user": {
                    "type": "string",
                    "description": "用户标识"
                  }
                }
              },
              "example": {
                "rating": "like",
                "user": "govai-user-d290f1ee"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "反馈成功",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "result": {
                      "type": "string",
                      "example": "success"
                    }
                  }
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    },
    "/conversations": {
      "get": {
        "summary": "获取 Dify 会话列表",
        "deprecated": false,
        "description": "获取指定用户在 Dify 侧的会话列表。\n\n**GovAI 调用场景：**\n- 对账：比对 PgSQL `chat_sessions` 与 Dify 会话记录\n- 调试：查看 Dify 侧的完整会话数据\n\n> ⚠️ GovAI 以 PgSQL `chat_sessions` 为主数据源，此接口仅用于对账/调试。\n",
        "operationId": "listConversations",
        "tags": [
          "Chat"
        ],
        "parameters": [
          {
            "name": "user",
            "in": "query",
            "description": "用户标识",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "last_id",
            "in": "query",
            "description": "上一页最后一条记录的 ID（游标分页）",
            "required": false,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "limit",
            "in": "query",
            "description": "",
            "required": false,
            "schema": {
              "type": "integer",
              "default": 20
            }
          },
          {
            "name": "sort_by",
            "in": "query",
            "description": "",
            "required": false,
            "schema": {
              "type": "string",
              "enum": [
                "created_at",
                "-created_at",
                "updated_at",
                "-updated_at"
              ],
              "default": "-updated_at"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "会话列表",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "data": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string"
                          },
                          "name": {
                            "type": "string"
                          },
                          "inputs": {
                            "type": "object",
                            "properties": {}
                          },
                          "status": {
                            "type": "string"
                          },
                          "created_at": {
                            "type": "integer"
                          },
                          "updated_at": {
                            "type": "integer"
                          }
                        }
                      }
                    },
                    "has_more": {
                      "type": "boolean"
                    },
                    "limit": {
                      "type": "integer"
                    }
                  }
                }
              }
            },
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    },
    "/conversations/{conversation_id}": {
      "delete": {
        "summary": "删除 Dify 会话",
        "deprecated": false,
        "description": "删除 Dify 侧的会话记录。\n\n**GovAI 调用场景：**\n- 用户删除会话时，先删 Dify 再删 PgSQL\n",
        "operationId": "deleteConversation",
        "tags": [
          "Chat"
        ],
        "parameters": [
          {
            "name": "conversation_id",
            "in": "path",
            "description": "",
            "required": true,
            "example": "",
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "user"
                ],
                "properties": {
                  "user": {
                    "type": "string"
                  }
                }
              }
            }
          },
          "required": true
        },
        "responses": {
          "204": {
            "description": "删除成功",
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    },
    "/conversations/{conversation_id}/name": {
      "post": {
        "summary": "重命名 Dify 会话",
        "deprecated": false,
        "description": "重命名 Dify 侧的会话。\n\n**GovAI 调用场景：**\n- 用户编辑会话名称时，同步更新 Dify 和 PgSQL\n",
        "operationId": "renameConversation",
        "tags": [
          "Chat"
        ],
        "parameters": [
          {
            "name": "conversation_id",
            "in": "path",
            "description": "",
            "required": true,
            "example": "",
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "name",
                  "user"
                ],
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "新的会话名称"
                  },
                  "auto_generate": {
                    "type": "boolean",
                    "default": false,
                    "description": "是否由 AI 自动生成会话名称"
                  },
                  "user": {
                    "type": "string"
                  }
                }
              },
              "example": {
                "name": "数据安全法相关讨论",
                "auto_generate": false,
                "user": "govai-user-d290f1ee"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "重命名成功",
            "headers": {}
          }
        },
        "security": [
          {
            "DifyApiKey": []
          }
        ]
      }
    }
  },
  "components": {
    "schemas": {
      "CreateDatasetRequest": {
        "type": "object",
        "required": [
          "name"
        ],
        "properties": {
          "name": {
            "type": "string",
            "maxLength": 255,
            "description": "知识库名称（必须唯一）"
          },
          "description": {
            "type": "string",
            "maxLength": 1000,
            "description": "知识库描述"
          },
          "permission": {
            "type": "string",
            "enum": [
              "only_me",
              "all_team_members"
            ],
            "default": "only_me",
            "description": "权限范围（Dify 内部权限，与 GovAI RBAC 无关）。\n建议固定为 `only_me`，GovAI 权限由 FastAPI 侧 RBAC 控制。\n"
          },
          "indexing_technique": {
            "type": "string",
            "enum": [
              "high_quality",
              "economy"
            ],
            "default": "high_quality",
            "description": "索引方式。\n- `high_quality`：高质量模式（使用 embedding 模型，消耗 token）\n- `economy`：经济模式（使用离线向量引擎，不消耗 token）\n"
          }
        }
      },
      "CreateDocumentByTextRequest": {
        "type": "object",
        "required": [
          "name",
          "text",
          "indexing_technique",
          "process_rule"
        ],
        "properties": {
          "name": {
            "type": "string",
            "description": "文档名称"
          },
          "text": {
            "type": "string",
            "description": "文档文本内容"
          },
          "indexing_technique": {
            "type": "string",
            "enum": [
              "high_quality",
              "economy"
            ]
          },
          "process_rule": {
            "$ref": "#/components/schemas/ProcessRule"
          }
        }
      },
      "ProcessRule": {
        "type": "object",
        "required": [
          "mode"
        ],
        "properties": {
          "mode": {
            "type": "string",
            "enum": [
              "automatic",
              "custom"
            ],
            "description": "处理模式。\n- `automatic`：自动分块（推荐，Dify 自行决定分块策略）\n- `custom`：自定义分块规则\n"
          },
          "rules": {
            "type": "object",
            "description": "自定义规则（仅 mode=custom 时有效）",
            "properties": {
              "pre_processing_rules": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "string",
                      "enum": [
                        "remove_extra_spaces",
                        "remove_urls_emails"
                      ],
                      "description": "预处理规则 ID。\n- `remove_extra_spaces`：移除多余空格\n- `remove_urls_emails`：移除 URL 和邮箱\n"
                    },
                    "enabled": {
                      "type": "boolean"
                    }
                  }
                }
              },
              "segmentation": {
                "type": "object",
                "properties": {
                  "separator": {
                    "type": "string",
                    "description": "分块分隔符（如 `###`、`\\n\\n`）",
                    "default": "###"
                  },
                  "max_tokens": {
                    "type": "integer",
                    "description": "每个分片的最大 token 数",
                    "default": 500,
                    "minimum": 100,
                    "maximum": 4000
                  }
                }
              }
            }
          }
        }
      },
      "AddSegmentsRequest": {
        "type": "object",
        "required": [
          "segments"
        ],
        "properties": {
          "segments": {
            "type": "array",
            "items": {
              "type": "object",
              "required": [
                "content"
              ],
              "properties": {
                "content": {
                  "type": "string",
                  "description": "分片内容（必填）"
                },
                "answer": {
                  "type": "string",
                  "description": "分片答案（QA 模式时填写）"
                },
                "keywords": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "description": "关键词列表（用于关键词检索）"
                }
              }
            }
          }
        }
      },
      "RetrievalRequest": {
        "type": "object",
        "required": [
          "query",
          "retrieval_model"
        ],
        "properties": {
          "query": {
            "type": "string",
            "description": "检索查询文本"
          },
          "retrieval_model": {
            "type": "object",
            "properties": {
              "search_method": {
                "type": "string",
                "enum": [
                  "keyword_search",
                  "semantic_search",
                  "full_text_search",
                  "hybrid_search"
                ],
                "description": "检索方法"
              },
              "reranking_enable": {
                "type": "boolean",
                "default": false,
                "description": "是否启用重排序"
              },
              "reranking_mode": {
                "type": "string",
                "nullable": true
              },
              "reranking_model": {
                "type": "object",
                "properties": {
                  "reranking_provider_name": {
                    "type": "string"
                  },
                  "reranking_model_name": {
                    "type": "string"
                  }
                }
              },
              "weights": {
                "type": "number",
                "description": "混合检索时的权重",
                "nullable": true
              },
              "top_k": {
                "type": "integer",
                "default": 5,
                "minimum": 1,
                "maximum": 20,
                "description": "返回结果数量"
              },
              "score_threshold_enabled": {
                "type": "boolean",
                "default": false
              },
              "score_threshold": {
                "type": "number",
                "description": "分数阈值（0-1）",
                "nullable": true
              }
            }
          }
        }
      },
      "WorkflowRunRequest": {
        "type": "object",
        "required": [
          "inputs",
          "response_mode",
          "user"
        ],
        "properties": {
          "inputs": {
            "type": "object",
            "description": "Workflow 输入变量（key-value 键值对）。\n不同 Workflow 的输入变量不同，参见各 Workflow 说明。\n",
            "additionalProperties": true,
            "properties": {}
          },
          "response_mode": {
            "type": "string",
            "enum": [
              "blocking",
              "streaming"
            ],
            "description": "响应模式。\n- `blocking`：等待完成后返回完整结果（推荐用于公文处理）\n- `streaming`：SSE 流式输出（适用于实时展示进度）\n"
          },
          "user": {
            "type": "string",
            "description": "用户唯一标识。GovAI 中使用 user UUID。\nDify 用此字段区分不同用户的调用。\n"
          },
          "files": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "type": {
                  "type": "string",
                  "enum": [
                    "image",
                    "document"
                  ]
                },
                "transfer_method": {
                  "type": "string",
                  "enum": [
                    "remote_url",
                    "local_file"
                  ]
                },
                "url": {
                  "type": "string"
                },
                "upload_file_id": {
                  "type": "string"
                }
              }
            },
            "description": "文件列表（如 Workflow 需要文件输入时使用）"
          }
        }
      },
      "ChatMessageRequest": {
        "type": "object",
        "required": [
          "query",
          "response_mode",
          "user"
        ],
        "properties": {
          "inputs": {
            "type": "object",
            "description": "App 定义变量（首次对话时传入，后续对话会自动继承）。\nGovAI 可传入 `dataset_ids` 等自定义变量（需在 Dify App 中定义）。\n",
            "additionalProperties": true,
            "properties": {},
            "example": {}
          },
          "query": {
            "type": "string",
            "maxLength": 10000,
            "description": "用户问题文本"
          },
          "response_mode": {
            "type": "string",
            "enum": [
              "blocking",
              "streaming"
            ],
            "default": "streaming",
            "description": "响应模式。GovAI 固定使用 `streaming`"
          },
          "conversation_id": {
            "type": "string",
            "description": "Dify 会话 ID。\n- 首次对话：留空或不传\n- 续接对话：传入上次返回的 conversation_id\n- 对应 PgSQL `chat_sessions.dify_conversation_id`\n"
          },
          "user": {
            "type": "string",
            "description": "用户唯一标识（GovAI user UUID）"
          },
          "files": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {}
            },
            "description": "文件列表（暂不使用）"
          }
        }
      },
      "DifyError": {
        "type": "object",
        "properties": {
          "code": {
            "type": "string",
            "description": "Dify 错误码"
          },
          "message": {
            "type": "string",
            "description": "错误消息"
          },
          "status": {
            "type": "integer",
            "description": "HTTP 状态码"
          }
        }
      },
      "DatasetResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "description": "知识库 ID（**存入 kb_collections.dify_dataset_id**）"
          },
          "name": {
            "type": "string"
          },
          "description": {
            "type": "string",
            "nullable": true
          },
          "provider": {
            "type": "string"
          },
          "permission": {
            "type": "string"
          },
          "data_source_type": {
            "type": "string",
            "nullable": true
          },
          "indexing_technique": {
            "type": "string",
            "nullable": true
          },
          "app_count": {
            "type": "integer"
          },
          "document_count": {
            "type": "integer"
          },
          "word_count": {
            "type": "integer"
          },
          "created_by": {
            "type": "string"
          },
          "created_at": {
            "type": "integer",
            "description": "Unix 时间戳"
          },
          "updated_by": {
            "type": "string"
          },
          "updated_at": {
            "type": "integer"
          },
          "embedding_model": {
            "type": "string",
            "nullable": true
          },
          "embedding_model_provider": {
            "type": "string",
            "nullable": true
          },
          "embedding_available": {
            "type": "boolean",
            "nullable": true
          }
        }
      },
      "DatasetListResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/DatasetResponse"
            }
          },
          "has_more": {
            "type": "boolean"
          },
          "limit": {
            "type": "integer"
          },
          "total": {
            "type": "integer"
          },
          "page": {
            "type": "integer"
          }
        }
      },
      "DocumentResponse": {
        "type": "object",
        "properties": {
          "document": {
            "type": "object",
            "properties": {
              "id": {
                "type": "string",
                "format": "uuid",
                "description": "文档 ID（**存入 kb_files.dify_document_id**）"
              },
              "position": {
                "type": "integer"
              },
              "data_source_type": {
                "type": "string"
              },
              "data_source_info": {
                "type": "object",
                "properties": {
                  "upload_file_id": {
                    "type": "string"
                  }
                },
                "nullable": true
              },
              "dataset_process_rule_id": {
                "type": "string"
              },
              "name": {
                "type": "string",
                "description": "文档名称"
              },
              "created_from": {
                "type": "string",
                "description": "创建来源（`api` 或 `web`）"
              },
              "created_by": {
                "type": "string"
              },
              "created_at": {
                "type": "integer"
              },
              "tokens": {
                "type": "integer",
                "description": "文档总 token 数"
              },
              "indexing_status": {
                "type": "string",
                "enum": [
                  "waiting",
                  "indexing",
                  "completed",
                  "paused",
                  "error"
                ],
                "description": "索引状态。\n- `waiting`：等待处理\n- `indexing`：索引中\n- `completed`：完成\n- `paused`：暂停\n- `error`：失败\n"
              },
              "error": {
                "type": "string",
                "nullable": true
              },
              "enabled": {
                "type": "boolean"
              },
              "disabled_at": {
                "type": "integer",
                "nullable": true
              },
              "disabled_by": {
                "type": "string",
                "nullable": true
              },
              "archived": {
                "type": "boolean"
              },
              "display_status": {
                "type": "string",
                "description": "显示状态（queuing, indexing, completed 等）"
              },
              "word_count": {
                "type": "integer"
              },
              "hit_count": {
                "type": "integer",
                "description": "命中次数"
              },
              "doc_form": {
                "type": "string",
                "description": "文档形式（text_model, qa_model）"
              }
            }
          },
          "batch": {
            "type": "string",
            "description": "批次 ID（**存入 kb_files.dify_batch_id**）。\n用于查询索引进度 `GET /indexing-status`\n"
          }
        }
      },
      "DocumentListResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "id": {
                  "type": "string"
                },
                "position": {
                  "type": "integer"
                },
                "data_source_type": {
                  "type": "string"
                },
                "name": {
                  "type": "string"
                },
                "created_from": {
                  "type": "string"
                },
                "created_by": {
                  "type": "string"
                },
                "created_at": {
                  "type": "integer"
                },
                "tokens": {
                  "type": "integer"
                },
                "indexing_status": {
                  "type": "string"
                },
                "error": {
                  "type": "string",
                  "nullable": true
                },
                "enabled": {
                  "type": "boolean"
                },
                "archived": {
                  "type": "boolean"
                }
              }
            }
          },
          "has_more": {
            "type": "boolean"
          },
          "limit": {
            "type": "integer"
          },
          "total": {
            "type": "integer"
          },
          "page": {
            "type": "integer"
          }
        }
      },
      "IndexingStatusResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "id": {
                  "type": "string"
                },
                "indexing_status": {
                  "type": "string",
                  "enum": [
                    "waiting",
                    "indexing",
                    "completed",
                    "paused",
                    "error"
                  ]
                },
                "processing_started_at": {
                  "type": "number",
                  "nullable": true
                },
                "parsing_completed_at": {
                  "type": "number",
                  "nullable": true
                },
                "cleaning_completed_at": {
                  "type": "number",
                  "nullable": true
                },
                "splitting_completed_at": {
                  "type": "number",
                  "nullable": true
                },
                "completed_at": {
                  "type": "number",
                  "nullable": true
                },
                "paused_at": {
                  "type": "number",
                  "nullable": true
                },
                "error": {
                  "type": "string",
                  "nullable": true
                },
                "stopped_at": {
                  "type": "number",
                  "nullable": true
                },
                "completed_segments": {
                  "type": "integer",
                  "description": "已完成的分片数"
                },
                "total_segments": {
                  "type": "integer",
                  "description": "总分片数"
                }
              }
            }
          }
        }
      },
      "SegmentListResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "id": {
                  "type": "string"
                },
                "position": {
                  "type": "integer"
                },
                "document_id": {
                  "type": "string"
                },
                "content": {
                  "type": "string"
                },
                "answer": {
                  "type": "string",
                  "nullable": true
                },
                "word_count": {
                  "type": "integer"
                },
                "tokens": {
                  "type": "integer"
                },
                "keywords": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                "index_node_id": {
                  "type": "string"
                },
                "index_node_hash": {
                  "type": "string"
                },
                "hit_count": {
                  "type": "integer"
                },
                "enabled": {
                  "type": "boolean"
                },
                "disabled_at": {
                  "type": "integer",
                  "nullable": true
                },
                "disabled_by": {
                  "type": "string",
                  "nullable": true
                },
                "status": {
                  "type": "string",
                  "enum": [
                    "waiting",
                    "indexing",
                    "completed",
                    "error"
                  ]
                },
                "created_by": {
                  "type": "string"
                },
                "created_at": {
                  "type": "integer"
                },
                "indexing_at": {
                  "type": "integer",
                  "nullable": true
                },
                "completed_at": {
                  "type": "integer",
                  "nullable": true
                },
                "error": {
                  "type": "string",
                  "nullable": true
                },
                "stopped_at": {
                  "type": "integer",
                  "nullable": true
                }
              }
            }
          },
          "doc_form": {
            "type": "string"
          }
        }
      },
      "RetrievalResponse": {
        "type": "object",
        "properties": {
          "query": {
            "type": "object",
            "properties": {
              "content": {
                "type": "string"
              }
            }
          },
          "records": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "segment": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "string"
                    },
                    "position": {
                      "type": "integer"
                    },
                    "document_id": {
                      "type": "string"
                    },
                    "content": {
                      "type": "string"
                    },
                    "answer": {
                      "type": "string",
                      "nullable": true
                    },
                    "word_count": {
                      "type": "integer"
                    },
                    "tokens": {
                      "type": "integer"
                    },
                    "keywords": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    },
                    "index_node_id": {
                      "type": "string"
                    },
                    "hit_count": {
                      "type": "integer"
                    },
                    "enabled": {
                      "type": "boolean"
                    },
                    "status": {
                      "type": "string"
                    },
                    "created_at": {
                      "type": "integer"
                    },
                    "document": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string"
                        },
                        "data_source_type": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        },
                        "doc_type": {
                          "type": "string",
                          "nullable": true
                        }
                      }
                    }
                  }
                },
                "score": {
                  "type": "number",
                  "format": "double",
                  "description": "相关性分数（0-1，越高越相关）"
                }
              }
            }
          }
        }
      },
      "WorkflowBlockingResponse": {
        "type": "object",
        "properties": {
          "workflow_run_id": {
            "type": "string",
            "description": "工作流运行 ID"
          },
          "task_id": {
            "type": "string",
            "description": "任务 ID"
          },
          "data": {
            "type": "object",
            "properties": {
              "id": {
                "type": "string"
              },
              "workflow_id": {
                "type": "string"
              },
              "status": {
                "type": "string",
                "enum": [
                  "succeeded",
                  "failed",
                  "stopped"
                ],
                "description": "执行状态。\n- `succeeded`：成功\n- `failed`：失败\n- `stopped`：被用户停止\n"
              },
              "outputs": {
                "type": "object",
                "description": "Workflow 输出变量（key-value）。\n不同 Workflow 输出不同，参见各 Workflow 说明。\n",
                "additionalProperties": true,
                "properties": {}
              },
              "error": {
                "type": "string",
                "description": "错误信息（仅 status=failed 时有值）",
                "nullable": true
              },
              "elapsed_time": {
                "type": "number",
                "format": "double",
                "description": "执行耗时（秒）"
              },
              "total_tokens": {
                "type": "integer",
                "description": "消耗的总 token 数"
              },
              "total_steps": {
                "type": "integer",
                "description": "执行的总节点数"
              },
              "created_at": {
                "type": "integer",
                "description": "创建时间（Unix 时间戳）"
              },
              "finished_at": {
                "type": "integer",
                "description": "完成时间（Unix 时间戳）"
              }
            }
          }
        }
      },
      "WorkflowSSEEvent": {
        "type": "object",
        "description": "Workflow 流式响应的 SSE 事件。\n\n每个事件以 `data: {...}` 格式发送。",
        "required": [
          "event"
        ],
        "properties": {
          "event": {
            "type": "string",
            "enum": [
              "workflow_started",
              "node_started",
              "node_finished",
              "text_chunk",
              "workflow_finished",
              "error",
              "ping"
            ],
            "description": "事件类型。\n- `workflow_started`：工作流开始执行\n- `node_started`：节点开始执行\n- `node_finished`：节点执行完成\n- `text_chunk`：LLM 流式输出的文本片段\n- `workflow_finished`：工作流执行完成\n- `error`：执行异常\n- `ping`：心跳保活\n"
          },
          "task_id": {
            "type": "string",
            "description": "任务 ID（workflow_started 事件）"
          },
          "workflow_run_id": {
            "type": "string",
            "description": "工作流运行 ID（workflow_started 事件）"
          },
          "node_id": {
            "type": "string",
            "description": "节点 ID（node_started/node_finished 事件）"
          },
          "node_type": {
            "type": "string",
            "description": "节点类型（node_started 事件），如 llm, code, http-request 等"
          },
          "title": {
            "type": "string",
            "description": "节点标题（node_started 事件）"
          },
          "outputs": {
            "type": "object",
            "description": "节点输出（node_finished 事件）或工作流最终输出（workflow_finished 事件）",
            "additionalProperties": true
          },
          "status": {
            "type": "string",
            "enum": [
              "succeeded",
              "failed",
              "stopped"
            ],
            "description": "执行状态（node_finished/workflow_finished 事件）"
          },
          "elapsed_time": {
            "type": "number",
            "format": "double",
            "description": "执行耗时（秒）（node_finished/workflow_finished 事件）"
          },
          "total_tokens": {
            "type": "integer",
            "description": "消耗的总 token 数（workflow_finished 事件）"
          },
          "text": {
            "type": "string",
            "description": "文本片段（text_chunk 事件）"
          },
          "message": {
            "type": "string",
            "description": "错误消息（error 事件）"
          },
          "code": {
            "type": "string",
            "description": "错误代码（error 事件）"
          }
        },
        "examples": [
          {
            "event": "workflow_started",
            "task_id": "task-a8c6c36f-9f5d",
            "workflow_run_id": "wfr-d290f1ee-6c54-4b01-90e6"
          },
          {
            "event": "node_started",
            "node_id": "llm-node-1",
            "node_type": "llm",
            "title": "公文起草 LLM"
          },
          {
            "event": "text_chunk",
            "text": "关于加强数据安全"
          },
          {
            "event": "node_finished",
            "node_id": "llm-node-1",
            "outputs": {
              "text": "关于加强数据安全管理的通知..."
            },
            "status": "succeeded",
            "elapsed_time": 8.5
          },
          {
            "event": "workflow_finished",
            "outputs": {
              "generated_text": "关于加强数据安全管理的通知..."
            },
            "status": "succeeded",
            "elapsed_time": 12.5,
            "total_tokens": 1500
          },
          {
            "event": "error",
            "message": "LLM request failed",
            "code": "llm_error"
          }
        ]
      },
      "ChatSSEEvent": {
        "type": "object",
        "description": "Chat 流式响应的 SSE 事件。\n\n每个事件以 `data: {...}` 格式发送。\n\n**GovAI 使用说明：**\n- `message` 事件：拼接 `answer` 字段构建完整回答\n- `message_end` 事件：提取 `metadata.retriever_resources` 作为引用来源\n- 其他事件：根据需要处理或忽略\n",
        "required": [
          "event"
        ],
        "properties": {
          "event": {
            "type": "string",
            "enum": [
              "message",
              "message_end",
              "message_file",
              "error",
              "ping"
            ],
            "description": "事件类型。\n- `message`：LLM 逐 token 输出的文本片段\n- `message_end`：消息完成，包含元数据和引用来源\n- `message_file`：文件类型输出（暂不使用）\n- `error`：执行异常\n- `ping`：心跳保活\n"
          },
          "message_id": {
            "type": "string",
            "description": "消息 ID（message/message_end 事件）"
          },
          "conversation_id": {
            "type": "string",
            "description": "会话 ID（message/message_end 事件）。\n首次对话时 Dify 返回新的 conversation_id，后续对话需传入此值。\n"
          },
          "answer": {
            "type": "string",
            "description": "文本片段（message 事件）。\n每个 message 事件包含一小段文本，需要拼接成完整回答。\n"
          },
          "created_at": {
            "type": "integer",
            "description": "创建时间戳（message 事件）"
          },
          "metadata": {
            "type": "object",
            "description": "元数据（message_end 事件）",
            "properties": {
              "usage": {
                "type": "object",
                "description": "Token 使用统计",
                "properties": {
                  "prompt_tokens": {
                    "type": "integer",
                    "description": "输入 token 数"
                  },
                  "completion_tokens": {
                    "type": "integer",
                    "description": "输出 token 数"
                  },
                  "total_tokens": {
                    "type": "integer",
                    "description": "总 token 数"
                  }
                }
              },
              "retriever_resources": {
                "type": "array",
                "description": "RAG 检索到的引用来源。\n**GovAI 核心字段**：用于构建 citations 数组。\n",
                "items": {
                  "type": "object",
                  "properties": {
                    "position": {
                      "type": "integer",
                      "description": "引用序号（从 1 开始）"
                    },
                    "dataset_id": {
                      "type": "string",
                      "description": "知识库 ID"
                    },
                    "dataset_name": {
                      "type": "string",
                      "description": "知识库名称"
                    },
                    "document_id": {
                      "type": "string",
                      "description": "文档 ID"
                    },
                    "document_name": {
                      "type": "string",
                      "description": "文档名称"
                    },
                    "segment_id": {
                      "type": "string",
                      "description": "分片 ID"
                    },
                    "score": {
                      "type": "number",
                      "format": "double",
                      "description": "相关性分数（0-1）"
                    },
                    "content": {
                      "type": "string",
                      "description": "引用的原文内容"
                    }
                  }
                }
              }
            }
          },
          "type": {
            "type": "string",
            "description": "文件类型（message_file 事件），如 image, document"
          },
          "url": {
            "type": "string",
            "description": "文件 URL（message_file 事件）"
          },
          "message": {
            "type": "string",
            "description": "错误消息（error 事件）"
          },
          "code": {
            "type": "string",
            "description": "错误代码（error 事件）"
          }
        },
        "examples": [
          {
            "event": "message",
            "message_id": "msg-a8c6c36f-9f5d",
            "conversation_id": "conv-d290f1ee-6c54",
            "answer": "根据《数据安全法》",
            "created_at": 1695308667
          },
          {
            "event": "message",
            "message_id": "msg-a8c6c36f-9f5d",
            "conversation_id": "conv-d290f1ee-6c54",
            "answer": "第二十一条规定",
            "created_at": 1695308667
          },
          {
            "event": "message_end",
            "message_id": "msg-a8c6c36f-9f5d",
            "conversation_id": "conv-d290f1ee-6c54",
            "metadata": {
              "usage": {
                "prompt_tokens": 500,
                "completion_tokens": 200,
                "total_tokens": 700
              },
              "retriever_resources": [
                {
                  "position": 1,
                  "dataset_id": "dataset-123",
                  "dataset_name": "政策法规知识库",
                  "document_id": "doc-456",
                  "document_name": "数据安全法.pdf",
                  "segment_id": "seg-789",
                  "score": 0.95,
                  "content": "第二十一条 国家建立数据分类分级保护制度..."
                }
              ]
            }
          },
          {
            "event": "error",
            "message": "LLM request failed",
            "code": "llm_error"
          }
        ]
      }
    },
    "responses": {},
    "securitySchemes": {
      "DifyApiKey": {
        "type": "http",
        "scheme": "bearer",
        "description": "Dify API Key 认证。\n请求头格式：`Authorization: Bearer {api_key}`\n不同接口使用不同的 API Key（参见 info.description 中的 Key 分类表）。\n"
      }
    }
  },
  "servers": [],
  "security": [
    {
      "DifyApiKey": []
    }
  ]
}